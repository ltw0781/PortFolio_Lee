<!DOCTYPE html>
<html xmlns:th="http: //www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layouts/board_layout}" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글상세</title>
</head>

<body layout:fragment="content">

    <section class="board-detail-section">
        <form action="/board/delete" method="post" type>



            <!-- 상단 영역: 카테고리 / 제목 / 작성자 -->
            <div class="detail-header glass">
                <div class="category" th:text="${board.category}"></div>

                <h2 class="detail-title" th:text="${board.title}">신규 이벤트 안내 및 참여 방법 안내드립니다</h2>

                <div class="detail-info">
                    <span th:text="|작성자 : ${board.writer}|">작성자: 관리자</span>
                    <span th:text="${#dates.format(board.createdAt, 'YYYY-MM-dd')}">등록일: 2025-01-10</span>
                    <span th:text="${board.viewCount}">조회수: 123</span>
                </div>
            </div>

            <!-- 내용 영역 -->
            <div class="detail-content glass">
                <p th:text="${board.content}">
                    안녕하세요. 고객 여러분!
                    이번 시즌 신규 이벤트가 진행됩니다.
                    다양한 혜택과 즐거운 콘텐츠가 준비되어 있으니 많은 참여 부탁드립니다.
                </p>
            </div>

            <!-- 파일 리스트 -->
            <div class="detail-files glass">
                <h3>첨부 파일</h3>

                <div class="file-list">
                    <div class="file-item">
                        <table>
                            <thead>
                                <tr>
                                    <th>no</th>
                                    <th>이미지</th>
                                    <th>파일명</th>
                                    <th>용량</th>
                                    <th>타입</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <th:block th:if="${fileList.isEmpty()}">
                                <tr>
                                    <td colspan="6" align="center">조회된 데이터가 없습니다.</td>
                                </tr>
                            </th:block>
                            <th:block th:each="file : ${fileList}">
                                <tr>
                                    <td th:text="${file.no}"></td>
                                    <td>
                                        <img th:src="|/img?id=${file.id}|" height="100" alt="파일 이미지">
                                    </td>
                                    <td th:text="${file.fileName}"></td>
                                    <td th:text="${file.fileSize}"></td>
                                    <td th:text="${file.type}"></td>
                                    <td>
                                        <button type="button" th:onclick="download( [[${file.id}]] )">다운로드</button>
                                        <!-- <button type="button" th:onclick="remove( this, [[${file.id}]])">삭제</button> -->
                                    </td>
                                </tr>
                            </th:block>
                        </table>
                    </div>
                </div>
            </div>
        </form>

        <!-- 댓글 작성 영역 -->
        <div class="comment-write glass">

            <h3>댓글 작성</h3>

            <div class="input-group">
                <label>작성자</label>
                <input type="text" placeholder="이름을 입력하세요" />
            </div>

            <div class="input-group">
                <label>내용</label>
                <textarea placeholder="댓글 내용을 입력하세요"></textarea>
            </div>

            <button class="btn-primary comment-submit">등록</button>
        </div>

        <!-- 댓글 목록 -->
        <div class="comment-list glass">

            <h3>댓글 목록</h3>

            <div class="comment-item">
                <div class="comment-header">
                    <strong class="comment-title">좋은 정보 감사합니다!</strong>
                    <span class="comment-writer">홍길동</span>
                    <span class="comment-date">2025-01-10</span>
                </div>
                <p class="comment-body">
                    이벤트 참여하고 왔습니다. 혜택 구성 좋네요!
                </p>
            </div>

            <div class="comment-item">
                <div class="comment-header">
                    <strong class="comment-title">기대됩니다!</strong>
                    <span class="comment-writer">이태원</span>
                    <span class="comment-date">2025-01-09</span>
                </div>
                <p class="comment-body">
                    어떤 혜택이 있는지 궁금합니다.
                </p>
            </div>
        </div>

    </section>



    <script>



        // 수정화면 이동
        function moveUpdate() {
            let id = "[[${board.id}]]"
            location.href = '/board/update?id=' + id
        }

        function moveList() {
            location.href = '/board/list'
        }

        // 다운로드
        function download(id) {
            location.href = `/file/${id}`
        }

        // 댓글 등록
        function insertComment() {
            const boardNo = '[[${board.no}]]'
            let writer = document.getElementById('writer').value
            let content = document.getElementById('content').value
            console.log(`writer : ${writer}`);
            console.log(`content : ${content}`);

            let data = {

                'boardNo': boardNo,
                'writer': writer,
                'content': content
            }

            let request = new XMLHttpRequest()
            let url = '/comment'
            request.open('POST', url, true)
            request.setRequestHeader('Content-Type', 'application/json')
            request.send(JSON.stringify(data))

            request.onreadystatechange = function () {
                if (request.readyState == request.DONE && request.status == 200) {
                    let response = request.responseText
                    if (response == 'SUCCESS') {
                        console.log('댓글 등록 성공')
                        // 댓글 목롣 갱신
                        commentList()

                        // 입력한 작성자 및 내용 비우기
                        document.getElementById('writer').value = ""
                        document.getElementById('content').value = ""
                    }
                }
            }
        }

        // 댓글 목록
        commentList()
        function commentList() {
            let request = new XMLHttpRequest()
            let boardNo = "[[${board.no}]]"
            let url = `/comment?boardNo=${boardNo}`
            request.open('GET', url, true)
            request.send()

            request.onreadystatechange = function () {
                let commentList = request.responseText
                let $commentList = document.getElementById('comment-list')
                $commentList.innerHTML = commentList
            }
        }

        function removeComment(id) {

            let request = new XMLHttpRequest()
            let url = `/comment/${id}`
            request.open('DELETE', url, true)
            request.send()
            request.onreadystatechange = function () {
                if (request.readyState == request.DONE && request.status == 200) {

                    let response = request.responseText
                    if (response == 'SUCCESS') {
                        console.log('댓글 삭제 성공')

                        commentList()
                    }
                    else {
                        alert('댓글 삭제 실패')
                    }


                }
            }

        }

        // 댓글 [수정] 버튼 클릭 시 - 수정 폼으로 전환
        function editComment(button, id) {
            console.log(button)

            let $table = button.closest('table')

            console.log($table);

            // 기존 작성자와 기존 내용을 가져오기
            console.log($table.querySelector('.comment-writer'))

            let writer = $table.querySelector('.comment-writer').textContent
            let content = $table.querySelector('.comment-content').textContent
            console.log(writer)
            console.log(content)

            // 기존 조회 폼은 숨김
            $table.style.display = 'none'

            // 수정 폼 삽입
            let updateForm = `
                <table border="1" style="width: 300px;">
                    <tr>
                        <td>
                            <input type="text" name="writer" id="comment-writer" value="${writer}" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <textarea name="content" id="comment-content" rows="5" cols="40">${content}</textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">
                            <button type="button" onclick="updateComment( '${id}' )">수정</button>
                            <button type="button" onclick="cancelComment( this )">취소</button>
                        </td>
                    </tr>
                </table>
            `
            // DOM 노드는 after() 함수로 다음 요소로 추가
            // $table.after(updateForm)
            // 텍스트로된 html 코드를 다음 요소로 추가
            $table.insertAdjacentHTML("afterend", updateForm)
        }

        // 댓글 수정 요청
        function updateComment(id) {
            console.log(`id : ${id}`);
            let commentWriter = document.getElementById('comment-writer').value
            let commentContent = document.getElementById('comment-content').value

            let data = {
                'id': id,
                'writer': commentWriter,
                'content': commentContent
            }

            let request = new XMLHttpRequest()
            let url = '/comment'
            request.open('PUT', url, true)
            request.setRequestHeader('content-Type', 'application/json')
            request.send(JSON.stringify(data))

            request.onreadystatechange = function () {
                if (request.readyState == request.DONE && request.status == 200) {
                    let response = request.responseText
                    if (response == 'SUCCESS') {
                        console.log('댓글 수정 성공')
                        commentList()// 댓글 목록 갱신
                    }
                    else (
                        alert('댓글 수정 실패')
                    )
                }
            }

        }

        // 댓글 수정 중 - 취소 버튼 클릭 시
        function cancelComment(cancelButton) {
            // 수정폼
            let $table = cancelButton.closest('table')

            // 조회폼
            let $comment = $table.previousElementSibling // 바로 앞의 형제자매 요소

            $comment.style.display = 'table'            // 조회폼 보여주기
            $table.remove()                            // 수정폼 제거

        }

    </script>
</body>

</html>