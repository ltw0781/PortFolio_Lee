<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글상세</title>
</head>

<body>
    <form action="/board/delete" method="post">
        <h3>상세화면</h3>
        <label for="title">제목</label>
        <input type="text" name="title" id="title" th:value="${board.title}" readonly>
        <br>
        <label for="title">작성자</label>
        <input type="text" name="writer" id="writer" th:value="${board.writer}" readonly>
        <br>
        <label for="title">내용</label>
        <textarea name="content" id="content" th:text="${board.content}"></textarea>

        <button type="button" onclick="moveUpdate()">수정</button>
        <button type="button" onclick="moveList()">목록</button>

        <h3>파일목록</h3>
        <table border="1">
            <thead>
                <tr>
                    <th>no</th>
                    <th>id</th>
                    <th>이미지</th>
                    <th>파일명</th>
                    <th>용량</th>
                    <th>타입</th>
                    <th>액션</th>
                </tr>
            </thead>
            <th:block th:each="file : ${fileList}">
                <tr>
                    <td th:text="${file.no}"></td>
                    <td th:text="${file.id}"></td>
                    <td>
                        <img th:src="|/img?id=${file.id}|" height="100" alt="파일 이미지">
                    </td>
                    <td th:text="${file.fileName}"></td>
                    <td th:text="${file.fileSize}"></td>
                    <td th:text="${file.type}"></td>
                    <td>
                        <button type="button" th:onclick="download( [[${file.id}]] )">다운로드</button>
                        <button type="button" th:onclick="remove( this, [[${file.id}]])">삭제</button>
                    </td>
                </tr>
            </th:block>
        </table>
    </form>

    <script>

        let id = "[[${board.id}]]"

        // 수정화면 이동
        function moveUpdate() {
            location.href = '/board/update?id=' + id
        }

        function moveList() {
            location.href = '/board/list'
        }

        function download(id) {
            location.href = `/file/${id}`
        }

        // 파일 삭제
        function remove( element, id ) {
            let request = new XMLHttpRequest()

            request.onreadystatechange = function() {

                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText
                    if ( response == 'SUCCESS' ) {
                        alert('파일 삭제 성공')
                        // 파일 목록 갱신
                        // 방법1 - 페이지 새로고침
                        // location.reload()

                        // 방법2 - DOM으로 파일 항목 행 삭제
                        alert(element)
                        console.log(element);
                        element.parentNode.parentNode.remove() // button > td > tr

                        // 방법3 - 파일목록 비동기로 요청
                        // 1. JSON 데이터를 받고 렌더링

                        // 2. 파일목록 뷰(html)를 응답받아 렌더링
                        
                    }
                    else {
                        alert('파일 삭제 실패')
                    }
                }

            }
            const url = `/file/${id}`
            request.open('DELETE', url, true)
            request.send()
        }


    </script>
</body>

</html>